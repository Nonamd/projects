<!doctype html>
<html>
<head>
  <!--FIREBASE -->
  <script src='https://cdn.firebase.com/js/client/2.2.1/firebase.js'></script>
  <!-- JQUERY -->    
  <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
  <script src="sha256.js"></script>


  <!-- BOOTSTRAP -->
  <!-- links to include BOOTSTRAP to your project-->
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/css/bootstrap.min.css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/css/bootstrap-responsive.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/js/bootstrap-modal.min.js"></script>
  <!--Fontawesome info -->  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

  <!--CSS -->
  <link rel='stylesheet' type='text/css' href='css/style.css'>
    
</head>
 
<body>
  <div class-"container">
    <div class="jumbotron">

      <!-- <h1> f&#224ilte gu</h1>    
      <h1> Cabadaich</h1> -->
          <a href="#" data-toggle="tooltip" data-placement="right" title="Welcome to Gaelic Chat!"><font color="#EEFCFC">f&#224ilte gu</font></br> <font color="#09347C">Cabadaich</font></a>
          <!-- <p><a id="login" class="btn btn-primary btn-lg " href="#" role="button">cl&#224raich a-steach</a>
          <a id="logout" button type="button" class="btn btn-warning" onclick=logout()>cl&#224raich a-mach</button>
        </a>
      </p> -->
    </div>
  </div>

  <!-- This is the combined login box attempt -->

  <div class="row">
    <div class="col-xs-5 col-xs-offset-4">
      <div class="LoginOptionWindow">
        <h3 class="LoginFormHeader">How Would You Like to Login? </h3>
        <div class="row">
          <div class="col-xs-4">
              <a id="facebook-signin" href="javascript:login('facebook');">
                <i id="facebook-signin-btn" class="fa fa-facebook-square fa-5x"></i>
                <p>Facebook</p>
              </a>
          </div>

          <div class="col-xs-4">
            <a id="twitter-signin" href="javascript:login('twitter');">
              <i id="twitter-signin-btn" class="fa fa-twitter-square fa-5x"></i>
              <p>Truitrich /Twitter</p>
            </a>
          </div>

          <div class="col-xs-4">
            <a id="email-sign-in">
              <i id="email-signin-btn" class="fa fa-envelope-o fa-5x"></i>
              <p>email</p>
            </a>
          </div>
        </div>
      </div>

      <div class="LoginEmailWindow" style="display: none;">
        <div class="form-group">
          <div class="row"> 
            <p>Or, Use your email &amp; password</p>
          <label class="email optional control-label" for="user_email">Email</label>
          <input autofocus="autofocus" class="string email optional form-control" id="user_email" name="user[email]" placeholder="Enter email" type="email" value="">
        </div>
      </div>

        <div class="form-group">
          <label class="password optional control-label" for="user_password">Password</label>
          <input class="form-control" id="user_password" name="user[password]" placeholder="Enter password" type="password">
        </div>

        <div class="form-group">
          <div class="checkbox">
            <input name="user[remember_me]" type="hidden" value="0"><label class="checkbox"><input checked="checked" class="boolean optional" id="user_remember_me" inline_label="true" name="user[remember_me]" type="checkbox" value="1"> Remember me</label>
          </div>
        </div>
      
        <input class="btn btn btn-success" name="commit" type="submit" value="Sign in">
        <button type="button" id="LoginRegisterButton">Register</button>
        <button type="button" id="LoginCancel">Cancel</button>
      </div>
    </div>

    <div class="main-chat-register" style="display: none;">
      <div class="container">
        <h1>Do I Need This?</h1>

        <div class="row">
          <div class="col-sm-12">
              <input type="text" class="btn-celticCustom" id="register-name" value="" placeholder="Your Name" />
          </div>
          <div class="col-sm-12">
              <input type="text" class="btn-block" id="register-email" value="" placeholder="Your e-mail address" />
          </div>
          <div class="col-sm-12">
            <input type="text" class="btn-block" id="register-password" value="" placeholder="Your password" />
          </div>
          <div class="col-sm-12">
            <label>Photo</label>
            <input type="file" id="photo" />
          </div>
          <div class="col-sm-12">
            <button type="button" class="btn btn-block btn-primary" id="register-button">Register</button>
          </div>
          <div class="col-sm-12">
            <button type="button" class="btn btn-block btn-danger" id="login-window-button">Login</button>
          </div>
        </div>
      </div>
    </div>
  </div>   
  


<!--     <form accept-charset="UTF-8" action="/users/sign_in" class="simple_form new_user" id="new_user" method="post" novalidate="novalidate"><div style="display:none"><input name="utf8" type="hidden" value="âœ“"><input name="authenticity_token" type="hidden" value="vNdEJyJn690hf/zcThJl2cBFxcqvmTlDK1wRrr49Fi4=" authenticity_token="vNdEJyJn690hf/zcThJl2cBFxcqvmTlDK1wRrr49Fi4="></div> -->
      
      <!-- <div class="form-group">
        <div class="col-xs-3">
                 <a id="facebook-signin" href="javascript:login('facebook');">
                   <i id="facebook-signin-btn" class="fa fa-facebook-square fa-5x"></i>
                   <p>Facebook</p>
                 </a>
        </div> 
      </div> -->

      
      
    <!-- or <a href="/users/sign_up">Sign up</a>

<div class="user-links">
    <a href="/users/password/new">Forgot your password?</a>

    <a href="/users/confirmation/new">Didn't receive confirmation instructions?</a>

</div>


</form>  </div>
  
</div> -->

<!-- End of Login Screen Options -->



<div class="main-chat-login">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
            <input type="text" class="btn-celticCustom" id="email" value="" placeholder="Your e-mail address" />
        </div>
        <div class="col-sm-12">
          <input type="text" class="btn-celticCustom" id="password" value="" placeholder="Your password" />
        </div>
        <div class="col-sm-12">
          <button type="button" class="btn-celticCustom2" id="login-button">Login</button>
        </div>
        <div class="col-sm-12">
          <button type="button" class="btn-celticCustom3" id="register-display-button">Register</button>
        </div>
      </div>
    </div>
  </div>

  

  <div class="main-chat-display">
    <h1><img src="" id="displayphoto" style="height: 40px; width: 40px;" /> <span id="displayname"></span></h1>
      <div class="row">
            <div class="col-xs-4 visit">
              <p>Modh Conaltraidh</p>
                <button type="button" class="btn-channel" onclick="channel('News')">Naidheachd</button>
                <button type="button" class="btn-channel" onclick="channel('Music & Song')">Ce&#242l & &#210ranach</button>
                <button type="button" class="btn-channel" onclick="channel('Stories & Poetry')">Sgeul & D&#224nachd</button>
                <button type="button" class="btn-channel" onclick="channel('Polish & Grammar')">Snasadh & Gr&#224mar</button>
                <button type="button" class="btn-channel" onclick="channel('Projects')">Pr&#242iseactean &#217r</button>
                <button type="button" class="btn-channel" onclick="channel('Stay & Work')">Fuirich & Oibrich</button>
            </div>
      </div>

      <div class="col-xs-8">
        <div class="row">
          <div class="col-xs-10">
              <div id='messagesDiv' class="messages"></div>
              <!-- <a href="#" data-toggle="tooltip" title="Write a message here!">teachdaireachd'</a> -->
          </div>
        </div>
              <input type='text' id='messageInput' class="InputBox" placeholder='teachdaireachd'>    
        </div>
      </div>
    </div>





<!-- <div class="container">
  <h3>Tooltip Example</h3>
  <a href="#" data-toggle="tooltip" title="Hooray!">Hover over me</a>
</div>

   <div class= "container-fluid">
      <div class="row">
          <div class="col-xs-4 visit">
            <p>Modh Conaltraidh</p>
        
          </div>
      <div class="col-xs-8">
        <div class="row">
          <div class="col-xs-10">
              <div id='messagesDiv' class="messages"></div>
              <a href="#" data-toggle="tooltip" title="Write a message here!">teachdaireachd'</a>
          </div>
        </div>

              <input type='text' id='messageInput' class="InputBox" placeholder='teachdaireachd'>    
        </div>
      </div>
    </div> -->

    <div><a href="javascript:logout();">Logout</a></div>


    <div class="modal fade" id="auth-modal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title text-center">Dearbhaich </h4> <!--authenticate -->
      </div>
      <div class="modal-body text-center">
        <div class="row">
          <div class="col-md-3"></div>
          <div class="col-md-3">
            <a id="twitter-signin" href="javascript:login('twitter');">
               <i id="twitter-signin-btn" class="fa fa-twitter-square fa-5x"></i>
               <p>Truitrich /Twitter</p>
            </a>
          </div>

          <div class="col-md-3">
             <a id="facebook-signin" href="javascript:login('facebook');">
               <i id="facebook-signin-btn" class="fa fa-facebook-square fa-5x"></i>
               <p>Facebook</p>
             </a>
           </div>  
          <!--<div class="col-md-3"></div>-->
      </div>
    </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


    <script>
      var myDataRef = new Firebase('https://cabadaich.firebaseio.com/');
      var string = $("#robstring").html();
      var name= "";
      var authModal = $('#auth-modal').modal( {show: false}); //this cluase hides the modal unless 
      //the user tries to enter a message without being logged in//
      //check to see if the user is logged in using getAuth fx

      // Create a callback which logs the current auth state
      var authData = myDataRef.getAuth();

   //var formattedString = string.replace(/(?:(?:ht|f)tp(?:s?)\:\/\/|~\/|\/)?(?:\w+:\w+@)?((?:(?:[-\w\d{1-3}]+\.)+(?:com|org|net|gov|mil|biz|info|mobi|name|aero|jobs|edu|co\.uk|ac\.uk|it|fr|tv|museum|asia|local|travel|[a-z]{2}))|((\b25[0-5]\b|\b[2][0-4][0-9]\b|\b[0-1]?[0-9]?[0-9]\b)(\.(\b25[0-5]\b|\b[2][0-4][0-9]\b|\b[0-1]?[0-9]?[0-9]\b)){3}))(?::[\d]{1,5})?(?:(?:(?:\/(?:[-\w~!$+|.,=]|%[a-f\d]{2})+)+|\/)+|\?|#)?(?:(?:\?(?:[-\w~!$+|.,*:]|%[a-f\d{2}])+=?(?:[-\w~!$+|.,*:=]|%[a-f\d]{2})*)(?:&(?:[-\w~!$+|.,*:]|%[a-f\d{2}])+=?(?:[-\w~!$+|.,*:=]|%[a-f\d]{2})*)*)*(?:#(?:[-\w~!$ |\/.,*:;=]|%[a-f\d]{2})*)?/ig, "<a href='http://$1'>$1</a>");
    //alert(formattedString);
    //$("#robstring").html(formattedString);
    

    $(document).ready(function() {

      $("#email-sign-in").click(function(){
        $(".LoginOptionWindow").hide();
        $(".LoginEmailWindow").show();  
      });

      $("#LoginCancel").click(function(){
        $(".LoginEmailWindow").hide();  
        $(".LoginOptionWindow").show();
      });


      $("#LoginRegisterButton").click(function() {
        $(".LoginEmailWindow").hide();
        $(".main-chat-register").show();
      });

      $("#login-window-button").click(function() {
        $(".main-chat-register").hide();
        $(".LoginEmailWindow").show();
      });





      function authDataCallback(authData) {
        if (authData) {
          alert("User " + authData.uid + " is logged in with " + authData.provider);
          console.log("User " + authData.uid + " is logged in with " + authData.provider);
        } else {
          console.log("User is logged out");
        }
      }
      myDataRef.onAuth(authDataCallback);
      
      $("#login-button").click(function() {
        var email = $("#email").val();
        var password = $("#password").val();
        myDataRef.authWithPassword({
          email    : email,
          password : password
        }, function(error, authData) {
          if (error) {
            console.log("Login Failed!", error);
          } else {
            console.log("Authenticated successfully with payload:", authData);
            myDataRef.child('user').child(authData.uid).once("value", function(snapshot) {
              var user = snapshot.val();
              for (var key in user) {
                $("#displayname").html(user[key].name);
                document.getElementById("displayphoto").src = user[key].photo;
              } 
            });            
            $(".main-chat-login").hide();
            $(".main-chat-display").show();
          }
        });
      });
      $("#register-button").click(function() {
        var name = $("#register-name").val();
        var email = $("#register-email").val();
        var password = $("#register-password").val();
        myDataRef.createUser({
          email    : email,
          password : password
        }, function(error, userData) {
          if (error) {
            console.log("Error creating user:", error);
          } else {
            console.log("Successfully created user account with uid:", userData.uid);
            var photoinput = document.getElementById('photo');
            var f = photoinput.files[0];
            var reader = new FileReader();
            reader.onload = (function(theFile) {
              return function(e) {
                var filePayload = e.target.result;
                // Generate a location that can't be guessed using the file's contents and a random number
                //var hash = CryptoJS.SHA256(Math.random() + CryptoJS.SHA256(filePayload));
                var firebasephoto = new Firebase(myDataRef + '/photos/' + userData.uid + '/filePayload');
                // Set the file payload to Firebase and register an onComplete handler to stop the spinner and show the preview
                //firebasephoto.set(filePayload, function() { 
                  myDataRef.child('user').child(userData.uid).push({id:userData.uid, email:email, name:name, photo:e.target.result}); 
                  myDataRef.authWithPassword({
                    email    : email,
                    password : password
                  }, function(error, authData) {
                    if (error) {
                      console.log("Login Failed!", error);
                    } else {
                      console.log("Authenticated successfully with payload:", authData);
                      $(".main-chat-register").hide();
                      $(".main-chat-display").show();
                    }
                  });
                  
                //});
              };
            })(f);
            reader.readAsDataURL(f);
            
          }
        });
      });
    });   









//this is the beginning of the code that I created with Carol//
      function login(provider){
        console.log("login with ", provider);
        authModal.modal('hide');
        myDataRef.authWithOAuthPopup(provider, function(error, authData) {
          if (error) {
          console.log("Login Failed!", error);
          } else {
          console.log("Authenticated successfully with payload:", authData);
         //console.log("User " + authData.uid + " is logged in with " + authData.provider);
          var userId = authData.uid
          name = authData[authData.provider].displayName;
          myDataRef.child('user').child(userId).push({id: userId, name:name}); 
        }
      });
      }
        if (authData) { 
         $("#login").hide(); 
         $("#logout").show(); 
        }
        else {
         $("#login").show(); 
         $("#logout").hide(); 
          
          console.log("User is logged out");
        }

      // Register the callback to be fired every time auth state changes

      $('#messageInput').keypress(function (e) {
        if (e.keyCode == 13) {
          //check here to see if user is logged in
          if(!name){
            authModal.modal('show');
          } else { //don't allow submit unless there is a name!
            //var name = $('#nameInput').val();
            var text = $('#messageInput').val();
            myDataRef.child('messages').child('channel').push({name: name, text: text});
            $('#messageInput').val('');
          }
        }
      });

      // function login(provider){
      //   console.log("login with ", provider);
      //   authModal.modal('hide');
      //   myDataRef.authWithOAuthPopup(provider, function(error, authData) {
      //     if (error) {
      //     console.log("Login Failed!", error);
      //     } else {
      //     console.log("Authenticated successfully with payload:", authData);
      //     console.log(authData.facebook.cachedUserProfile.picture.data.url);
      //    //console.log("User " + authData.uid + " is logged in with " + authData.provider);
      //     var userId = authData.uid;
      //     name = authData[authData.provider].displayName;
      //     myDataRef.child('user').child(userId).once("value", function(snapshot) {
      //       var ifExists = snapshot.exist(); //a firebase function
      //       if (ifExists){
      //         console.log ('user is already in the system');
      //       } else{
      //         myDataRef.child('user').child(userID).push({id: userId, name:name}); 
      //       }
      //   }
      // });
      // }
          

      // function logout() {
      //   console.log("logging out");
      //   myDataRef.unauth();
      //   location.reload();
      // }

      // myDataRef.child('messages').on('child_added', function(snapshot) {
      //   var message = snapshot.val();
      //   displayChatMessage(message.name, message.text);
      // });
      // function displayChatMessage(name, text) {
      //   $('<div/>').text(text).prepend($('<em/>').text(name+': ')).appendTo($('#messagesDiv'));
      //   $('#messagesDiv')[0].scrollTop = $('#messagesDiv')[0].scrollHeight;
      // };
    </script>
  </body>
</html>